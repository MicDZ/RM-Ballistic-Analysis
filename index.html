<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂºπÈÅìËÆ°ÂàÜÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
        }
        
        .canvas-section {
            flex: 1;
            min-width: 600px;
            padding: 30px;
            border-right: 2px solid #eee;
        }
        
        .control-section {
            width: 300px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f0f4ff;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #e8f0ff;
        }
        
        .upload-area i {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        #fileInput {
            display: none;
        }
        
        .canvas-container {
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: auto;
            max-height: 700px;
            background: #fafafa;
        }
        
        canvas {
            display: block;
            cursor: crosshair;
        }
        
        .btn {
            width: 100%;
            padding: 12px 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        .btn-compact { padding: 10px 10px; font-size: 0.9em; margin: 0; }
        .btn-row, .btn-grid { width: 100%; }
        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .btn-grid .btn { margin: 0; }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .stats {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-top: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-weight: bold;
            color: #495057;
        }
        
        .stat-value {
            font-size: 1.05em;
            font-weight: bold;
            color: #667eea;
        }
        
        .point-count {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            margin: 15px 0;
            font-size: 1.1em;
        }
        
        /* ÊñáÊú¨Ê†áÊ≥®Êéß‰ª∂Ê†∑Âºè */
        .text-controls {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-top: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .text-controls h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .text-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .text-select, .text-color {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
        }
        .hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 8px;
        }
        .paper-controls {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-top: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .paper-controls h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        /* Èù∂‰∏≠ÂøÉÊ®°ÂºèÊéß‰ª∂Ê†∑ÂºèÔºå‰∏é paper-controls ‰∏ÄËá¥ */
        .center-controls {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-top: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .center-controls h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        .segmented {
            display: inline-flex;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .segmented button {
            padding: 8px 12px;
            border: none;
            background: #fff;
            cursor: pointer;
        }
        .segmented button.active {
            background: #667eea;
            color: #fff;
        }

        /* Ë£ÅÂâ™ÂºπÁ™óÊ†∑Âºè */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            width: min(92vw, 920px);
            max-height: 90vh;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .modal-header {
            padding: 14px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-weight: bold;
        }
        .modal-body {
            padding: 14px 18px;
            overflow: auto;
        }
        .modal-footer {
            padding: 12px 18px;
            background: #f7f7f9;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #eee;
        }
        .crop-toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .crop-canvas-wrap {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #fafafa;
            overflow: auto;
            display: inline-block;
            max-width: 100%;
        }
        #cropCanvas {
            display: block;
            max-width: 100%;
            background: #fff;
            cursor: crosshair;
        }

        @media (max-width: 1024px) {
            .canvas-section {
                border-right: none;
                border-bottom: 2px solid #eee;
                min-width: 100%;
            }
            
            .control-section {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ ÂºπÈÅìËÆ°ÂàÜÁ≥ªÁªü</h1>
            <p>‰∏ä‰º†Èù∂Á∫∏ÂõæÁâáÔºåÁÇπÂáªÊ†áËÆ∞ÂºπÂ≠î‰ΩçÁΩÆÔºåËá™Âä®ËÆ°ÁÆóÂæóÂàÜÂíåÁ≤æÂ∫¶</p>
        </div>
        
        <div class="main-content">
            <div class="canvas-section">
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3em; margin-bottom: 15px;">üì§</div>
                    <h3>ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†Èù∂Á∫∏ÂõæÁâá</h3>
                    <p style="color: #666; margin-top: 10px;">ÊîØÊåÅ JPG„ÄÅPNG Ê†ºÂºè</p>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                
                <div class="canvas-container" id="canvasContainer" style="display: none;">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
            
            <div class="control-section">
                <div class="point-count" id="pointCount">Â∑≤Ê†áËÆ∞ÁÇπÊï∞: 0</div>
                
                <div class="btn-grid" aria-label="primary actions">
                    <button class="btn btn-primary btn-compact" id="analyzeBtn" disabled title="ÂàÜÊûêÂºπÈÅì">üìä ÂàÜÊûê</button>
                    <button class="btn btn-secondary btn-compact" id="undoBtn" disabled title="Êí§ÈîÄ‰∏ä‰∏ÄÁÇπ">‚Ü©Ô∏è Êí§ÈîÄ</button>
                    <button class="btn btn-danger btn-compact" id="clearBtn" disabled title="Ê∏ÖÈô§ÊâÄÊúâÁÇπ">üóëÔ∏è Ê∏ÖÈô§</button>
                    <button class="btn btn-secondary btn-compact" id="downloadBtn" disabled title="‰∏ãËΩΩÁªìÊûúÂõæ">üíæ ÂõæÂÉè</button>
                    <button class="btn btn-secondary btn-compact" id="downloadDataBtn" disabled title="‰∏ãËΩΩÊï∞ÊçÆJSON">üßæ Êï∞ÊçÆ</button>
                </div>

                <div class="center-controls">
                    <h3>üéØ Èù∂‰∏≠ÂøÉÊ®°Âºè</h3>
                    <div class="form-row" style="justify-content:flex-start;">
                        <div class="segmented" role="group" aria-label="center mode">
                            <button id="centerModePointsBtn" class="active">ÁÇπÁæ§‰∏≠ÂøÉ</button>
                            <button id="centerModeImageBtn">ÂõæÁâá‰∏≠ÂøÉ</button>
                        </div>
                    </div>
                    <div class="hint">ÈÄâÊã©‰∏≠ÂøÉËÆ°ÁÆóÊñπÂºèÔºöÁÇπÁæ§‰∏≠ÂøÉÔºàÈªòËÆ§ÔºâÊàñÂõæÁâá‰∏≠ÂøÉ</div>
                </div>

                <div class="paper-controls">
                    <h3>üìÑ Ë£ÅÂâ™</h3>
                    <div class="form-row" style="justify-content: flex-end;">
                        <button class="btn btn-secondary btn-compact" id="startCropBtn" disabled title="ÊâìÂºÄË£ÅÂâ™ÂºπÁ™ó">‚úÇÔ∏è ÂºÄÂßãË£ÅÂâ™</button>
                    </div>
                </div>

                <div class="text-controls">
                    <h3>üìù ÊñáÊú¨Ê†áÊ≥®</h3>
                    <div class="form-row">
                        <input type="text" id="textInput" class="text-input" placeholder="ËæìÂÖ•Ë¶ÅÊ†áÊ≥®ÁöÑÊñáÊú¨...">
                    </div>
                    <div class="form-row">
                        <label for="textSize" class="stat-label" style="min-width: 30px;">Â≠óÂè∑</label>
                        <select id="textSize" class="text-select">
                            <option value="14">14</option>
                            <option value="16">16</option>
                            <option value="18" selected>18</option>
                            <option value="20">20</option>
                            <option value="24">24</option>
                            <option value="28">28</option>
                            <option value="32">32</option>
                        </select>
                        <label for="textColor" class="stat-label" style="min-width: 30px;">È¢úËâ≤</label>
                        <input type="color" id="textColor" class="text-color" value="#ff3b3b">
                    </div>
                    <div class="btn-grid" aria-label="text actions">
                        <button class="btn btn-primary btn-compact" id="placeTextBtn" disabled title="ÊîæÁΩÆÊñáÊú¨">üñäÔ∏è ÊîæÁΩÆ</button>
                        <button class="btn btn-secondary btn-compact" id="undoTextBtn" disabled title="Êí§ÈîÄÊñáÊú¨">‚Ü©Ô∏è Êí§ÈîÄ</button>
                        <button class="btn btn-danger btn-compact" id="clearTextBtn" disabled title="Ê∏ÖÈô§ÊñáÊú¨">üóëÔ∏è Ê∏ÖÈô§</button>
                    </div>
                    <div class="hint" id="textHint" style="display:none;">Â∑≤ËøõÂÖ•ÊñáÊú¨ÊîæÁΩÆÊ®°ÂºèÔºöÁÇπÂáªÁîªÂ∏ÉÁ°ÆÂÆö‰ΩçÁΩÆ</div>
                </div>

                <div class="stats" id="stats" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üìà ÂàÜÊûêÁªìÊûú</h3>
                    <div class="stat-item">
                        <span class="stat-label">Âπ≥ÂùáÁéØÊï∞</span>
                        <span class="stat-value" id="scoreValue">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Âπ≥ÂùáË∑ùÁ¶ª</span>
                        <span class="stat-value" id="distanceValue">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Â∞èË£ÖÁî≤ÂëΩ‰∏≠Áéá</span>
                        <span class="stat-value" id="smallHitValue">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Â§ßË£ÖÁî≤ÂëΩ‰∏≠Áéá</span>
                        <span class="stat-value" id="largeHitValue">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">È£ûÈïñÂëΩ‰∏≠Áéá</span>
                        <span class="stat-value" id="dartHitValue">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë£ÅÂâ™ÂºπÁ™ó -->
    <div class="modal-overlay" id="cropModal" aria-hidden="true" role="dialog" aria-label="Ë£ÅÂâ™ÂõæÁâá">
        <div class="modal" id="cropModalContent">
            <div class="modal-header">‚úÇÔ∏è Ë£ÅÂâ™ÂõæÁâá</div>
            <div class="modal-body">
                <div class="crop-toolbar">
                    <label for="modalPaperSizeSelect" class="stat-label" style="min-width: 30px;">Â∞∫ÂØ∏</label>
                    <select id="modalPaperSizeSelect" class="text-select">
                        <option value="A5">A5(148√ó210 mm)</option>
                        <option value="A4" selected>A4(210√ó297 mm)</option>
                        <option value="A3">A3(297√ó420 mm)</option>
                        <option value="Letter">Letter(216√ó279 mm)</option>
                        <option value="Legal">Legal(216√ó356 mm)</option>
                    </select>
                    <span class="hint">Êåâ‰ΩèÂπ∂ÊãñÊãΩ‰ª•Ê°ÜÈÄâÂå∫ÂüüÔºàÊåâÊâÄÈÄâÂ∞∫ÂØ∏ÊØî‰æãÁ∫¶ÊùüÔºåÊ®™ÂêëÔºâ</span>
                </div>
                <div class="crop-canvas-wrap">
                    <canvas id="cropCanvas"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-compact" id="cropCancelBtn" title="ÂèñÊ∂à">ÂèñÊ∂à</button>
                <button class="btn btn-primary btn-compact" id="cropConfirmBtn" title="Á°ÆËÆ§Ë£ÅÂâ™">Á°ÆËÆ§Ë£ÅÂâ™</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const canvasContainer = document.getElementById('canvasContainer');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const undoBtn = document.getElementById('undoBtn');
        const clearBtn = document.getElementById('clearBtn');
        const downloadBtn = document.getElementById('downloadBtn');
    const downloadDataBtn = document.getElementById('downloadDataBtn');
        const pointCount = document.getElementById('pointCount');
        const stats = document.getElementById('stats');
    // Ë£ÅÂâ™Êéß‰ª∂ÔºàÂºπÁ™óÔºâ
    const startCropBtn = document.getElementById('startCropBtn');
    const cropModal = document.getElementById('cropModal');
    const cropCanvas = document.getElementById('cropCanvas');
    const cropCtx = cropCanvas.getContext('2d');
    const modalPaperSizeSelect = document.getElementById('modalPaperSizeSelect');
    const cropConfirmBtn = document.getElementById('cropConfirmBtn');
    const cropCancelBtn = document.getElementById('cropCancelBtn');
    // ÊñáÊú¨Ê†áÊ≥®Áõ∏ÂÖ≥Êéß‰ª∂
    const textInput = document.getElementById('textInput');
    const textSize = document.getElementById('textSize');
    const textColor = document.getElementById('textColor');
    const placeTextBtn = document.getElementById('placeTextBtn');
    const undoTextBtn = document.getElementById('undoTextBtn');
    const clearTextBtn = document.getElementById('clearTextBtn');
    const textHint = document.getElementById('textHint');
    // Èù∂‰∏≠ÂøÉÊ®°ÂºèÊéß‰ª∂
    const centerModePointsBtn = document.getElementById('centerModePointsBtn');
    const centerModeImageBtn = document.getElementById('centerModeImageBtn');
        
        let img = new Image();
        let points = [];
        let actualImgShape = [1500, 2121]; // ÈªòËÆ§ÂõæÂÉèÂ∞∫ÂØ∏
        // Á∫∏Âº†Â∞∫ÂØ∏ÔºàmmÔºâÊò†Â∞ÑÔºåPortraitÔºàÁ´ñÂêëÔºâÂÆΩ√óÈ´ò
        const paperSizes = {
            A5: [148, 210],
            A4: [210, 297],
            A3: [297, 420],
            Letter: [216, 279],
            Legal: [216, 356]
        };
        let selectedPaperKey = 'A4';
        let orientation = 'landscape'; // Âõ∫ÂÆöÊ®™Âêë
        function getPageSizeMM() {
            const [w, h] = paperSizes[selectedPaperKey] || paperSizes.A4;
            return orientation === 'landscape' ? [h, w] : [w, h];
        }
        let pageSizeMM = getPageSizeMM(); // ÂΩìÂâçÈ°µÈù¢Áâ©ÁêÜÂ∞∫ÂØ∏ÔºàÊØ´Á±≥Ôºâ
    let hasCropped = false; // ÊòØÂê¶ËøõË°åËøáË£ÅÂâ™
    let labels = []; // ÊñáÊú¨Ê†áÊ≥® [{text, x, y, color, size}]
    let currentMode = 'point'; // 'point' | 'text'
    let pendingText = null;
    let centerMode = 'points'; // 'points' | 'image'
    let lastAnalysisCenter = null; // {x,y} ÊúÄËøë‰∏ÄÊ¨°ÂàÜÊûê‰ΩøÁî®ÁöÑ‰∏≠ÂøÉ
    // Ë£ÅÂâ™ÂºπÁ™óÁä∂ÊÄÅ
    let isCropModalOpen = false;
    // Áº©Áï•ÂõæÁº©ÊîæÊØî‰æãÔºàthumb -> originalÔºâ
    let thumbScale = 1; // original = thumb / thumbScale
    let thumbCropStart = null; // {x,y}
    let thumbCropRect = null; // {x,y,w,h}
        
        // Ë£ÖÁî≤ÊùøÂÆûÈôÖÂ∞∫ÂØ∏ÔºàÊØ´Á±≥Ôºâ
        let bigArmorSizeMM = [230, 127];
        let smallArmorSizeMM = [135, 125];
        let dartArmorSizeMM = [140, 140];
        
        // Ë£ÖÁî≤ÊùøÂÉèÁ¥†Â∞∫ÂØ∏ÔºàÊ†πÊçÆÂÆûÈôÖÂõæÁâáÂ∞∫ÂØ∏Âä®ÊÄÅËÆ°ÁÆóÔºâ
        let bigArmorSize = [0, 0];
        let smallArmorSize = [0, 0];
        let dartArmorSize = [0, 0];
        
        // ËÆ°ÁÆóË£ÖÁî≤ÊùøÂÉèÁ¥†Â∞∫ÂØ∏ÁöÑÂáΩÊï∞
        function calculateArmorSizes(imgWidth, imgHeight) {
            // Ê†πÊçÆÂÆûÈôÖÂõæÁâáÂ∞∫ÂØ∏ËÆ°ÁÆóÊØî‰æã
            bigArmorSize = [
                Math.floor(bigArmorSizeMM[0] / pageSizeMM[0] * imgWidth),
                Math.floor(bigArmorSizeMM[1] / pageSizeMM[1] * imgHeight)
            ];
            smallArmorSize = [
                Math.floor(smallArmorSizeMM[0] / pageSizeMM[0] * imgWidth),
                Math.floor(smallArmorSizeMM[1] / pageSizeMM[1] * imgHeight)
            ];
            dartArmorSize = [
                Math.floor(dartArmorSizeMM[0] / pageSizeMM[0] * imgWidth),
                Math.floor(dartArmorSizeMM[1] / pageSizeMM[1] * imgHeight)
            ];
        }
        
        // ‰∏ä‰º†Âå∫ÂüüÁÇπÂáª
    uploadArea.addEventListener('click', () => fileInput.click());
        
        // ÊãñÊãΩ‰∏ä‰º†
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#764ba2';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#667eea';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#667eea';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            }
        });
        
        // Êñá‰ª∂ÈÄâÊã©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        });
        
        // Âä†ËΩΩÂõæÁâá
        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    // Ê†πÊçÆÂÆûÈôÖÂõæÁâáÂ∞∫ÂØ∏ËÆ°ÁÆóË£ÖÁî≤ÊùøÂ§ßÂ∞è
                    calculateArmorSizes(img.width, img.height);
                    console.log('ÂõæÁâáÂ∞∫ÂØ∏:', img.width, 'x', img.height);
                    console.log('Â§ßË£ÖÁî≤Â∞∫ÂØ∏:', bigArmorSize);
                    console.log('Â∞èË£ÖÁî≤Â∞∫ÂØ∏:', smallArmorSize);
                    console.log('È£ûÈïñË£ÖÁî≤Â∞∫ÂØ∏:', dartArmorSize);
                    drawImage();
                    uploadArea.style.display = 'none';
                    canvasContainer.style.display = 'block';
                    points = [];
                    labels = [];
                    lastAnalysisCenter = null;
                    stats.style.display = 'none';
                    downloadBtn.disabled = true;
                    // ÂêØÁî®Ë£ÅÂâ™
                    startCropBtn.disabled = false;
                    hasCropped = false;
                    updateUI();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // ÁªòÂà∂ÂõæÁâáÂíåÁÇπ
        function drawImage() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            // ÁªòÂà∂ÊâÄÊúâÁÇπ
            points.forEach(point => {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
                ctx.beginPath();
                ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });

            // ÁªòÂà∂ÊñáÊú¨Ê†áÊ≥®
            labels.forEach(lbl => {
                const fontSize = Number(lbl.size) || 18;
                ctx.font = `${fontSize}px Arial`;
                ctx.textBaseline = 'top';
                // ÁôΩËâ≤ÊèèËæπÂ¢ûÂº∫ÂèØËØªÊÄß
                ctx.lineWidth = Math.max(2, Math.floor(fontSize / 9));
                ctx.strokeStyle = 'rgba(255,255,255,0.9)';
                ctx.strokeText(lbl.text, lbl.x, lbl.y);
                // Â°´ÂÖÖÈ¢úËâ≤
                ctx.fillStyle = lbl.color || '#ff3b3b';
                ctx.fillText(lbl.text, lbl.x, lbl.y);
            });

            // ‰∏ªÁîªÂ∏É‰∏çÂÜçÁªòÂà∂Ë£ÅÂâ™Ë¶ÜÁõñÂ±ÇÔºàË£ÅÂâ™ÊîπÂú®ÂºπÁ™ó‰∏≠Ôºâ
        }
        
        // ÁîªÂ∏ÉÁÇπÂáª
        canvas.addEventListener('click', (e) => {
            // ÂºπÁ™óÊâìÂºÄÊó∂‰∏ªÁîªÂ∏É‰∫§‰∫íË¢´ÈÅÆÊå°ÔºõÊ≠§Â§Ñ‰øùÈô©ËøîÂõû
            if (isCropModalOpen) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (currentMode === 'text' && pendingText) {
                // ÊîæÁΩÆÊñáÊú¨
                labels.push({
                    text: pendingText.text,
                    x, y,
                    color: pendingText.color,
                    size: pendingText.size
                });
                pendingText = null;
                currentMode = 'point';
                textHint.style.display = 'none';
                drawImage();
                updateUI();
                return;
            }

            // ÈªòËÆ§ÔºöËÆ∞ÂΩïÁÇπ
            points.push({x, y});
            drawImage();
            updateUI();
        });
        
        // Êõ¥Êñ∞UI
        function updateUI() {
            pointCount.textContent = `Â∑≤Ê†áËÆ∞ÁÇπÊï∞: ${points.length}`;
            const hasImage = canvasContainer.style.display === 'block';
            // ÂºπÁ™óÊâìÂºÄÊó∂Á¶ÅÁî®‰ª•‰∏ãÊåâÈíÆ
            analyzeBtn.disabled = isCropModalOpen || points.length === 0;
            undoBtn.disabled = isCropModalOpen || points.length === 0;
            clearBtn.disabled = isCropModalOpen || points.length === 0;
            // ÊñáÊú¨ÊåâÈíÆÂêØÁî®ÈÄªËæë
            placeTextBtn.disabled = isCropModalOpen || !(hasImage && textInput.value.trim().length > 0);
            undoTextBtn.disabled = isCropModalOpen || labels.length === 0;
            clearTextBtn.disabled = isCropModalOpen || labels.length === 0;
            // Ë£ÅÂâ™ÊåâÈíÆÈÄªËæë
            startCropBtn.disabled = !hasImage || isCropModalOpen;
            // Êï∞ÊçÆÂØºÂá∫ÊåâÈíÆ
            downloadDataBtn.disabled = !hasImage || isCropModalOpen;
            // Èù∂‰∏≠ÂøÉÊ®°ÂºèÂàáÊç¢ÊåâÈíÆ
            if (centerModePointsBtn && centerModeImageBtn) {
                centerModePointsBtn.disabled = !hasImage || isCropModalOpen;
                centerModeImageBtn.disabled = !hasImage || isCropModalOpen;
                centerModePointsBtn.classList.toggle('active', centerMode === 'points');
                centerModeImageBtn.classList.toggle('active', centerMode === 'image');
            }
        }
        
        // Êí§ÈîÄ‰∏ä‰∏ÄÁÇπ
        undoBtn.addEventListener('click', () => {
            points.pop();
            drawImage();
            updateUI();
            stats.style.display = 'none';
            downloadBtn.disabled = true;
        });
        
        // Ê∏ÖÈô§ÊâÄÊúâÁÇπ
        clearBtn.addEventListener('click', () => {
            points = [];
            drawImage();
            updateUI();
            stats.style.display = 'none';
            downloadBtn.disabled = true;
        });

        // ÊñáÊú¨ËæìÂÖ•ÂèòÂåñÊó∂ÔºåÊõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
        textInput.addEventListener('input', updateUI);

        // ËøõÂÖ•ÊñáÊú¨ÊîæÁΩÆÊ®°Âºè
        placeTextBtn.addEventListener('click', () => {
            const text = textInput.value.trim();
            if (!text) return;
            pendingText = {
                text,
                color: textColor.value || '#ff3b3b',
                size: Number(textSize.value) || 18
            };
            currentMode = 'text';
            textHint.style.display = 'block';
        });

        // Êí§ÈîÄÊñáÊú¨
        undoTextBtn.addEventListener('click', () => {
            labels.pop();
            pendingText = null;
            currentMode = 'point';
            textHint.style.display = 'none';
            drawImage();
            updateUI();
        });

        // Ê∏ÖÈô§ÊâÄÊúâÊñáÊú¨
        clearTextBtn.addEventListener('click', () => {
            labels = [];
            pendingText = null;
            currentMode = 'point';
            textHint.style.display = 'none';
            drawImage();
            updateUI();
        });
        
        // ÂàÜÊûêÂºπÈÅì
        analyzeBtn.addEventListener('click', () => {
            if (points.length === 0) return;
            
            // ËÆ°ÁÆó‰∏≠ÂøÉÁÇπÔºàÊ†πÊçÆÊ®°ÂºèÔºâ
            let centerX, centerY;
            if (centerMode === 'image') {
                centerX = Math.floor(canvas.width / 2);
                centerY = Math.floor(canvas.height / 2);
            } else {
                // ÁÇπÁæ§‰∏≠ÂøÉ
                let xSum = 0, ySum = 0;
                points.forEach(p => {
                    xSum += p.x;
                    ySum += p.y;
                });
                centerX = Math.floor(xSum / points.length);
                centerY = Math.floor(ySum / points.length);
            }
            lastAnalysisCenter = { x: centerX, y: centerY };
            
            // ÈáçÁªòÂõæÁâá
            drawImage();
            
            // ÁªòÂà∂‰∏≠ÂøÉÁÇπ
            ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // ÁªòÂà∂ÂêåÂøÉÂúÜ
            for (let i = 1; i <= 10; i++) {
                ctx.strokeStyle = 'rgba(0, 255, 0, 0.6)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(centerX, centerY, i * 50, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // ËÆ°ÁÆóÂæóÂàÜÂíåË∑ùÁ¶ª
            let totalScore = 0;
            let totalDistance = 0;
            let hitSmall = 0, hitLarge = 0, hitDart = 0;

            points.forEach(point => {
                const dist = Math.sqrt((point.x - centerX) ** 2 + (point.y - centerY) ** 2);
                totalDistance += dist;
                
                // ËÆ°ÁÆóÁéØÊï∞
                for (let i = 1; i <= 10; i++) {
                    if (dist <= i * 50) {
                        const ringScore = 10 - i + 1;
                        totalScore += ringScore;
                        
                        // Ê†áËÆ∞ÁÇπÂíåÁéØÊï∞
                        ctx.fillStyle = 'rgba(0, 0, 255, 0.8)';
                        ctx.beginPath();
                        ctx.arc(point.x + 5, point.y + 5, 3, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = 'blue';
                        ctx.font = '16px Arial';
                        ctx.fillText(ringScore.toString(), point.x + 10, point.y + 10);
                        break;
                    }
                }
                
                // Âà§Êñ≠ÂëΩ‰∏≠Ë£ÖÁî≤Êùø
                if (Math.abs(point.x - centerX) <= smallArmorSize[0] / 2 &&
                    Math.abs(point.y - centerY) <= smallArmorSize[1] / 2) {
                    hitSmall++;
                }
                if (Math.abs(point.x - centerX) <= bigArmorSize[0] / 2 &&
                    Math.abs(point.y - centerY) <= bigArmorSize[1] / 2) {
                    hitLarge++;
                }
                if (Math.abs(point.x - centerX) <= dartArmorSize[0] / 2 &&
                    Math.abs(point.y - centerY) <= dartArmorSize[1] / 2) {
                    hitDart++;
                }
            });
            
            // ÁªòÂà∂Ë£ÖÁî≤ÊùøÊ°Ü
            ctx.strokeStyle = 'rgba(255, 255, 0, 0.8)';
            ctx.lineWidth = 3;
            ctx.strokeRect(centerX - smallArmorSize[0] / 2, centerY - smallArmorSize[1] / 2,
                          smallArmorSize[0], smallArmorSize[1]);
            
            ctx.strokeStyle = 'rgba(0, 100, 255, 0.8)';
            ctx.strokeRect(centerX - bigArmorSize[0] / 2, centerY - bigArmorSize[1] / 2,
                          bigArmorSize[0], bigArmorSize[1]);
            
            ctx.strokeStyle = 'rgba(255, 0, 255, 0.8)';
            ctx.strokeRect(centerX - dartArmorSize[0] / 2, centerY - dartArmorSize[1] / 2,
                          dartArmorSize[0], dartArmorSize[1]);
            
            // Ê†áËÆ∞‰∏≠ÂøÉ
            ctx.fillStyle = 'blue';
            ctx.font = '14px Arial';
            ctx.fillText(`‰∏≠ÂøÉ(${centerMode === 'points' ? 'ÁÇπÁæ§' : 'ÂõæÁâá'})`, centerX + 10, centerY - 10);
            
            // ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
            ctx.fillStyle = 'blue';
            ctx.font = 'bold 20px Arial';
            const avgScore = totalScore / points.length;
            const avgDist = totalDistance / points.length;
            
            ctx.fillText(`score = ${avgScore.toFixed(2)}`, 10, 50);
            ctx.fillText(`distance = ${avgDist.toFixed(2)}`, 10, 100);
            ctx.fillStyle = 'rgba(255, 255, 0, 1)';
            ctx.fillText(`hit_small = ${(hitSmall / points.length * 100).toFixed(1)}%`, 10, 150);
            ctx.fillStyle = 'rgba(0, 100, 255, 1)';
            ctx.fillText(`hit_large = ${(hitLarge / points.length * 100).toFixed(1)}%`, 10, 200);
            ctx.fillStyle = 'rgba(255, 0, 255, 1)';
            ctx.fillText(`hit_dart = ${(hitDart / points.length * 100).toFixed(1)}%`, 10, 250);
            
            // Êõ¥Êñ∞ÁªüËÆ°Èù¢Êùø
            document.getElementById('scoreValue').textContent = avgScore.toFixed(2);
            document.getElementById('distanceValue').textContent = avgDist.toFixed(2) + ' px';
            document.getElementById('smallHitValue').textContent = (hitSmall / points.length * 100).toFixed(1) + '%';
            document.getElementById('largeHitValue').textContent = (hitLarge / points.length * 100).toFixed(1) + '%';
            document.getElementById('dartHitValue').textContent = (hitDart / points.length * 100).toFixed(1) + '%';
            
            stats.style.display = 'block';
            downloadBtn.disabled = false;
        });
        // Êóß confirmCropBtn ÈÄªËæëÂ∑≤ÁßªÈô§

        // ÁîªÂ∏ÉË£ÅÂâ™‰∫ã‰ª∂‰∏éÊóßÈ°µÈù¢Â∞∫ÂØ∏ÊéßÂà∂Â∑≤ÁßªËá≥Ë£ÅÂâ™ÂºπÁ™ó

        // ========= Èù∂‰∏≠ÂøÉÊ®°ÂºèÂàáÊç¢ =========
        function setCenterMode(mode) {
            if (mode !== 'points' && mode !== 'image') return;
            centerMode = mode;
            // ÂàáÊç¢Ê†∑Âºè
            if (centerModePointsBtn && centerModeImageBtn) {
                centerModePointsBtn.classList.toggle('active', centerMode === 'points');
                centerModeImageBtn.classList.toggle('active', centerMode === 'image');
            }
            // ËÆæÁΩÆÂèòÊõ¥ÂêéÔºåËã•Â∑≤ÊúâÁªìÊûúÔºåÊ†áËÆ∞ÈúÄÈáçÊñ∞ÂàÜÊûê
            if (points.length > 0) {
                stats.style.display = 'none';
                downloadBtn.disabled = true;
                drawImage();
            }
            updateUI();
        }
        if (centerModePointsBtn) centerModePointsBtn.addEventListener('click', () => setCenterMode('points'));
        if (centerModeImageBtn) centerModeImageBtn.addEventListener('click', () => setCenterMode('image'));

        // ========= Êï∞ÊçÆÂØºÂá∫ =========
        function gatherExportData() {
            // ËØªÂèñÂàÜÊûêÁªìÊûúÔºàËã•Â≠òÂú®Ôºâ
            let analysis = null;
            if (stats && stats.style.display !== 'none') {
                const parsePercent = (s) => {
                    if (!s) return null;
                    const v = parseFloat(String(s).replace('%',''));
                    return isNaN(v) ? null : v;
                };
                const parsePx = (s) => {
                    if (!s) return null;
                    const v = parseFloat(String(s).replace('px',''));
                    return isNaN(v) ? null : v;
                };
                analysis = {
                    avgScore: parseFloat(document.getElementById('scoreValue')?.textContent) || null,
                    avgDistancePx: parsePx(document.getElementById('distanceValue')?.textContent),
                    hitSmallPercent: parsePercent(document.getElementById('smallHitValue')?.textContent),
                    hitLargePercent: parsePercent(document.getElementById('largeHitValue')?.textContent),
                    hitDartPercent: parsePercent(document.getElementById('dartHitValue')?.textContent),
                    center: lastAnalysisCenter ? { ...lastAnalysisCenter } : null,
                    centerMode
                };
            }

            return {
                timestamp: new Date().toISOString(),
                image: { width: canvas.width, height: canvas.height },
                page: { key: selectedPaperKey, orientation, sizeMM: [...pageSizeMM] },
                cropped: hasCropped,
                centerMode,
                armorMM: {
                    big: [...bigArmorSizeMM],
                    small: [...smallArmorSizeMM],
                    dart: [...dartArmorSizeMM]
                },
                armorPx: {
                    big: [...bigArmorSize],
                    small: [...smallArmorSize],
                    dart: [...dartArmorSize]
                },
                points: points.map(p => ({ x: Math.round(p.x), y: Math.round(p.y) })),
                labels: labels.map(l => ({ text: l.text, x: Math.round(l.x), y: Math.round(l.y), color: l.color, size: l.size })),
                analysis
            };
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function timestampName() {
            const d = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
        }

        downloadDataBtn.addEventListener('click', () => {
            const data = gatherExportData();
            downloadJSON(data, `ballistic_data_${timestampName()}.json`);
        });
    </script>
</body>
</html>